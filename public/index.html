<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Anon Chat + Reactions + Video</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#0f172a);color:var(--text);height:100vh;display:flex;align-items:center;justify-content:center}
  .wrap{width:min(960px,96vw);height:min(92vh,760px);display:grid;grid-template-rows:auto 1fr auto;gap:10px}
  .header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px;background:rgba(17,24,39,.7);border:1px solid rgba(255,255,255,.06);border-radius:16px;backdrop-filter:blur(8px)}
  .left{display:flex;align-items:center;gap:10px;font-weight:700}.dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
  .right{display:flex;gap:10px;align-items:center}
  #search{background:#283248;border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:10px;padding:8px 10px;min-width:200px}
  .online{font-size:14px;color:var(--muted)}
  .chat{overflow:auto;padding:10px;background:rgba(17,24,39,.6);border:1px solid rgba(255,255,255,.06);border-radius:16px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth}
  .msg{max-width:76%;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.05);background:rgba(255,255,255,.04);display:flex;flex-direction:column;gap:6px;position:relative}
  .me{align-self:flex-end;background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.22)}
  .meta{font-size:12px;color:var(--muted)} .text{white-space:pre-wrap;word-wrap:break-word}
  .actions{display:flex;gap:8px;align-items:center;font-size:18px}
  .reacts{font-size:14px;display:flex;gap:6px;align-items:center}
  .sys{text-align:center;color:var(--muted);font-size:13px;margin:6px 0}
  .input{display:flex;gap:10px;align-items:center;background:rgba(17,24,39,.7);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:8px}
  #m{flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:16px}
  button{border:none;background:var(--accent);color:#082614;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer}
  .picker{position:absolute;bottom:100%;left:0;transform:translateY(-6px);background:#0b1020;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:6px;display:none;gap:4px}
  .picker button{background:transparent;padding:6px 8px;border-radius:8px}
  .msg:hover .picker{display:flex}
  /* Video modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:10px}
  .modal .box{background:#0c1224;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;display:grid;gap:8px;width:min(920px,96vw)}
  .videos{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  video{width:100%;height:320px;background:#000;border-radius:12px}
  .row{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="left"><span class="dot"></span> Anon Chat</div>
      <div class="right">
        <input id="search" type="search" placeholder="T√¨m tin nh·∫Øn...">
        <div class="online">Online: <b id="online">0</b></div>
      </div>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>

    <form id="form" class="input" autocomplete="off">
      <input id="m" type="text" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="500"/>
      <button id="send" type="submit">G·ª≠i</button>
    </form>
  </div>

  <!-- Video modal -->
  <div id="videoModal" class="modal">
    <div class="box">
      <div class="row">
        <div><b>Video call</b> ‚Äî <span id="callWith">ƒêang k·∫øt n·ªëi‚Ä¶</span></div>
        <div>
          <button id="btnHang">K·∫øt th√∫c</button>
        </div>
      </div>
      <div class="videos">
        <video id="myVideo" autoplay muted playsinline></video>
        <video id="theirVideo" autoplay playsinline></video>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ---------- Helpers ----------
    const socket = io();
    const chat = document.getElementById("chat");
    const online = document.getElementById("online");
    const input = document.getElementById("m");
    const form = document.getElementById("form");
    const search = document.getElementById("search");
    const videoModal = document.getElementById("videoModal");
    const myVideo = document.getElementById("myVideo");
    const theirVideo = document.getElementById("theirVideo");
    const btnHang = document.getElementById("btnHang");
    const callWith = document.getElementById("callWith");

    function esc(s){
      return (s||"").toString()
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }
    function randomName(){
      const animals=["Tiger","Panda","Eagle","Fox","Dolphin","Falcon","Otter","Koala","Orca","Lynx","Wolf","Hawk","Bison","Seal","Koi"];
      const n=Math.floor(Math.random()*900)+100;
      return "Guest-"+animals[Math.floor(Math.random()*animals.length)]+"-"+n;
    }

    // ---------- Identity ----------
    const myName = localStorage.getItem("anon_name") || randomName();
    localStorage.setItem("anon_name", myName);
    socket.emit("hello", myName);

    // ---------- UI render ----------
    function addSys(text){
      const div=document.createElement("div");
      div.className="sys"; div.innerHTML=esc(text);
      chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
    }

    function reactionsToCounts(reactions){
      const counts={};
      Object.values(reactions||{}).forEach(e=>counts[e]=(counts[e]||0)+1);
      return counts; // { "‚ù§Ô∏è": 2, "üëç": 1 }
    }
    function countsToString(counts){
      return Object.entries(counts).map(([e,c])=>`${e} ${c}`).join(" ");
    }

    function renderMsg(msg){
      const el=document.createElement("div");
      el.className="msg"+(msg.sender===socket.id?" me":"");
      el.dataset.id=msg.id;
      el.dataset.text=msg.message.toLowerCase();
      el.innerHTML=`
        <div class="meta">${esc(msg.name)} ‚Ä¢ ${esc(msg.at)}</div>
        <div class="text">${esc(msg.message)}</div>
        <div class="actions">
          <span class="reacts">${countsToString(reactionsToCounts(msg.reactions))}</span>
          <div class="picker">
            <button title="Tim">‚ù§Ô∏è</button>
            <button title="Like">üëç</button>
            <button title="Ph·∫´n n·ªô">üò°</button>
            <button title="Haha">üòÇ</button>
            <button title="B·ªè">‚úñÔ∏è</button>
          </div>
          ${msg.sender!==socket.id ? `<button class="btnCall" title="G·ªçi video">üìπ</button>`:""}
        </div>
      `;

      // reaction handlers
      const picker=el.querySelector(".picker");
      picker.addEventListener("click",(e)=>{
        if(e.target.tagName!=="BUTTON")return;
        const emo=e.target.textContent.trim();
        socket.emit("react",{msgId:msg.id, emoji: (emo==="‚úñÔ∏è")? null : emo});
      });

      // call button
      const btn=el.querySelector(".btnCall");
      if(btn){
        btn.addEventListener("click",()=> startCall(msg.sender, msg.name));
      }
      return el;
    }

    function upsertMsg(msg){
      let el=[...document.querySelectorAll(".msg")].find(d=>d.dataset.id==msg.id);
      if(!el){ el=renderMsg(msg); chat.appendChild(el); }
      else{
        // update reacts text if already exists
        const reacts=el.querySelector(".reacts");
        reacts.textContent = countsToString(reactionsToCounts(msg.reactions||{}));
      }
      chat.scrollTop=chat.scrollHeight;
    }

    // ---------- Sockets ----------
    socket.on("sys", e=>{
      if(e.online!=null) online.textContent=e.online;
      if(e.type==="join") addSys(`${e.at} ‚Ä¢ ${e.name} ƒë√£ v√†o`);
      if(e.type==="leave") addSys(`${e.at} ‚Ä¢ ${e.name} ƒë√£ r·ªùi`);
    });

    socket.on("history", msgs=>{
      msgs.forEach(m=> upsertMsg(m));
      chat.scrollTop=chat.scrollHeight;
    });

    socket.on("chat", msg=> upsertMsg(msg));

    socket.on("updateMsg", ({id,reactions})=>{
      const el=[...document.querySelectorAll(".msg")].find(d=>d.dataset.id==id);
      if(el){
        const reacts=el.querySelector(".reacts");
        reacts.textContent = countsToString(reactionsToCounts(reactions||{}));
      }
    });

    // send message
    form.addEventListener("submit",e=>{
      e.preventDefault();
      const txt=input.value.trim();
      if(!txt) return;
      socket.emit("chat", txt);
      input.value="";
    });

    // search
    search.addEventListener("input", e=>{
      const q=e.target.value.toLowerCase();
      document.querySelectorAll(".msg").forEach(m=>{
        const t = (m.dataset.text||"");
        m.style.display = t.includes(q) ? "" : "none";
      });
    });

    // ---------- WebRTC 1‚Äì1 ----------
    let pc=null, localStream=null, peerId=null, peerName="";

    async function getLocalStream(){
      if(localStream) return localStream;
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      myVideo.srcObject = localStream;
      return localStream;
    }

    function createPC(){
      pc = new RTCPeerConnection({
        iceServers: [{urls:"stun:stun.l.google.com:19302"}]
      });
      pc.onicecandidate = (e)=>{
        if(e.candidate && peerId) socket.emit("webrtc-candidate",{to:peerId,candidate:e.candidate});
      };
      pc.ontrack = (e)=>{ theirVideo.srcObject = e.streams[0]; };
      return pc;
    }

    async function startCall(toId, toName){
      peerId = toId; peerName = toName || "";
      callWith.textContent = "ƒêang g·ªçi " + (peerName||peerId);
      videoModal.style.display="flex";
      pc = createPC();
      const stream = await getLocalStream();
      stream.getTracks().forEach(t=> pc.addTrack(t, stream));
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("webrtc-offer", { to: peerId, offer });
    }

    socket.on("webrtc-offer", async ({ from, offer })=>{
      // nh·∫≠n cu·ªôc g·ªçi
      peerId = from; callWith.textContent = "ƒêang k·∫øt n·ªëi v·ªõi " + from;
      videoModal.style.display="flex";
      pc = createPC();
      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const stream = await getLocalStream();
      stream.getTracks().forEach(t=> pc.addTrack(t, stream));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      socket.emit("webrtc-answer", { to: from, answer });
    });

    socket.on("webrtc-answer", async ({ from, answer })=>{
      if(!pc) return;
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    });

    socket.on("webrtc-candidate", async ({ from, candidate })=>{
      if(!pc) return;
      try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch {}
    });

    function endCall(send=true){
      try{ if(pc) pc.getSenders().forEach(s=>s.track && s.track.stop()); }catch{}
      try{ if(pc) pc.close(); }catch{}
      pc=null;
      // gi·ªØ localStream ƒë·ªÉ l·∫ßn sau kh·ªèi xin l·∫°i mic/cam ‚Äî n·∫øu mu·ªën t·∫Øt ho√†n to√†n th√¨:
      // localStream?.getTracks().forEach(t=>t.stop()); localStream=null;
      videoModal.style.display="none";
      if(send && peerId) socket.emit("webrtc-hangup",{to:peerId});
      peerId=null; peerName="";
    }

    btnHang.addEventListener("click", ()=> endCall(true));
    socket.on("webrtc-hangup", ()=> endCall(false));

    // ƒë√≥ng modal khi b·∫•m n·ªÅn t·ªëi
    videoModal.addEventListener("click",(e)=>{ if(e.target===videoModal) endCall(true); });
  </script>
</body>
</html>
