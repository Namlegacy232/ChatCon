<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anon Chat</title>
  <style>
    body {
      margin:0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background:linear-gradient(180deg,#0f172a,#1e293b);
      color:#f1f5f9;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    .wrap {
      width:min(900px,95%);
      height:90vh;
      display:flex;
      flex-direction:column;
      background:#111827cc;
      border-radius:20px;
      box-shadow:0 8px 30px rgba(0,0,0,0.4);
      overflow:hidden;
    }
    .header {
      background:#1e293b;
      padding:12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
    }
    .chat {
      flex:1;
      padding:16px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg {
      max-width:70%;
      padding:10px 14px;
      border-radius:14px;
      position:relative;
      animation:fadeIn .2s ease-in;
    }
    .msg .meta {
      font-size:12px;
      opacity:0.7;
      margin-bottom:3px;
    }
    .msg.you {
      align-self:flex-start;
      background:#374151;
    }
    .msg.me {
      align-self:flex-end;
      background:#22c55e;
      color:#083418;
    }
    .sys {
      text-align:center;
      font-size:13px;
      color:#94a3b8;
      margin:6px 0;
    }
    .input {
      display:flex;
      padding:10px;
      background:#1e293b;
    }
    input[type=text] {
      flex:1;
      padding:10px;
      border:none;
      border-radius:10px;
      outline:none;
      background:#334155;
      color:#f1f5f9;
    }
    button {
      margin-left:10px;
      padding:10px 16px;
      border:none;
      border-radius:10px;
      background:#22c55e;
      color:#083418;
      font-weight:600;
      cursor:pointer;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(5px); }
      to { opacity:1; transform:translateY(0); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>Anon Chat</div>
      <div id="online">0 online</div>
    </div>
    <div id="chat" class="chat"></div>
    <form id="form" class="input">
      <input id="m" type="text" placeholder="Nhập tin nhắn..." maxlength="500" autocomplete="off"/>
      <button>Gửi</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const chat = document.getElementById("chat");
    const online = document.getElementById("online");
    const input = document.getElementById("m");
    const form = document.getElementById("form");

    function esc(s) {
      return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    const myName = "Guest-" + Math.floor(Math.random()*1000);
    socket.emit("hello", myName);

    function addSys(msg) {
      const div = document.createElement("div");
      div.className = "sys";
      div.innerHTML = esc(msg);
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function addMsg({name,message,at,id}) {
      const div = document.createElement("div");
      div.className = "msg " + (id===socket.id ? "me":"you");
      div.innerHTML = `<div class="meta">${esc(name)} • ${esc(at)}</div><div>${esc(message)}</div>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    socket.on("sys", e => {
      online.textContent = (e.online||0) + " online";
      if(e.type==="join") addSys(`${e.at} • ${e.name} đã vào`);
      if(e.type==="leave") addSys(`${e.at} • ${e.name} đã rời`);
    });

    socket.on("chat", addMsg);

    // nhận lịch sử tin nhắn
    socket.on("history", msgs => {
      msgs.forEach(addMsg);
    });

    form.addEventListener("submit", e=>{
      e.preventDefault();
      const txt = input.value.trim();
      if(!txt) return;
      socket.emit("chat", txt);
      input.value="";
    });
  </script>
</body>
</html>
