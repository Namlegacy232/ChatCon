<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Anon Chat ‚Äì Liquid Glass</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0e1024; --bg2:#1a1f4a; --glass:rgba(255,255,255,.14); --glass-2:rgba(255,255,255,.22);
    --text:#e8eef7; --muted:#a8b3c7; --accent:#22c55e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 800px at 20% 10%, #2a3b85 0%, transparent 60%),
                radial-gradient(1200px 800px at 80% 90%, #1e7faa 0%, transparent 60%),
                linear-gradient(135deg, var(--bg1), var(--bg2));
    color:var(--text); display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .app{ width:min(980px,96vw); height:min(92vh,820px); display:grid; grid-template-rows:auto 1fr auto; gap:12px; }
  .glass{
    background:var(--glass);
    border:1px solid rgba(255,255,255,.12);
    border-radius:22px; backdrop-filter: blur(16px) saturate(1.2);
    box-shadow:0 10px 25px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.08);
  }
  .header{ padding:12px 14px; display:flex; align-items:center; gap:10px; justify-content:space-between; }
  .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px }
  .dot{ width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 10px var(--accent) }
  .weather{ font-size:14px; color:var(--muted); display:flex; align-items:center; gap:6px }
  .search{
    display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:14px;
    background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.14);
    transition:.25s transform, .25s box-shadow;
  }
  .search:focus-within{ transform:translateY(-1px); box-shadow:0 6px 18px rgba(0,0,0,.25) }
  .search input{
    background:transparent; border:none; outline:none; color:var(--text); min-width:220px; font-size:14px;
  }
  .chat{ padding:12px; overflow:auto; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth }
  .sys{ text-align:center; color:var(--muted); font-size:13px; }
  .msg{
    max-width:78%; padding:12px 14px; border-radius:18px; background:var(--glass-2);
    border:1px solid rgba(255,255,255,.16); display:flex; flex-direction:column; gap:6px;
    animation: slideUp .24s cubic-bezier(.2,.7,.2,1);
    position:relative; transform-origin: bottom;
  }
  .me{ align-self:flex-end; background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35) }
  .meta{ font-size:12px; color:var(--muted); display:flex; align-items:center; gap:6px; }
  .meta .name{ font-weight:600; color:#f5f8ff; display:flex; align-items:center; gap:6px }
  .text{ white-space:pre-wrap; word-wrap:break-word; font-size:15px }
  .actions{ display:flex; align-items:center; gap:8px; font-size:18px }
  .reactions{ font-size:14px; display:flex; align-items:center; gap:6px }
  .picker{
    position:absolute; bottom:100%; left:10px; transform: translateY(-8px) scale(.98);
    background: rgba(20,24,50,.92); border:1px solid rgba(255,255,255,.14); border-radius:14px;
    padding:6px 8px; display:none; gap:6px; box-shadow:0 8px 24px rgba(0,0,0,.4);
    animation: fadeIn .15s ease;
  }
  .msg:hover .picker{ display:flex }
  .picker button{ background:transparent; border:none; font-size:20px; cursor:pointer }
  .picker button:hover{ transform: translateY(-2px) scale(1.06) }
  .input{ padding:8px; display:flex; align-items:center; gap:10px; }
  .input .box{
    flex:1; display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:16px;
    background: rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.14);
    transition:.2s; 
  }
  .input .box:focus-within{ box-shadow:0 8px 22px rgba(0,0,0,.3); transform: translateY(-1px) }
  #m{ flex:1; background:transparent; border:none; outline:none; color:var(--text); font-size:16px }
  .send{ width:44px; height:44px; border:none; border-radius:50%; cursor:pointer; background:var(--accent); color:#082c17; font-weight:700 }
  /* Animations */
  @keyframes slideUp { from{opacity:0; transform:translateY(10px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)} }
  @keyframes pop { 0%{transform:scale(0.6); opacity:0} 60%{transform:scale(1.15); opacity:1} 100%{transform:scale(1)} }
  .burst{ position:absolute; right:-6px; bottom: -6px; pointer-events:none; animation:pop .32s ease }
</style>
</head>
<body>
  <div class="app">
    <div class="header glass">
      <div class="brand"><span class="dot"></span> <span>Anon Chat</span></div>
      <div style="display:flex; align-items:center; gap:10px">
        <div class="weather" id="weather"><span>‚õÖ</span><span>Nhi·ªÅu m√¢y</span></div>
        <div class="search">
          <span>üîé</span>
          <input id="search" type="search" placeholder="T√¨m tin nh·∫Øn...">
        </div>
      </div>
    </div>

    <div id="chat" class="chat glass" aria-live="polite"></div>

    <div class="input glass">
      <div class="box">
        <input id="m" type="text" maxlength="500" placeholder="Nh·∫≠p tin nh·∫Øn...">
      </div>
      <button class="send" id="send" title="G·ª≠i">‚û§</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // -------- Helpers --------
    const socket = io();
    const chat = document.getElementById("chat");
    const search = document.getElementById("search");
    const input = document.getElementById("m");
    const sendBtn = document.getElementById("send");
    const weatherEl = document.getElementById("weather");

    function esc(s){ return (s||"").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }

    // Generate persistent clientId
    function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)); }
    const storedId = localStorage.getItem("client_id") || (localStorage.setItem("client_id", uuid()), localStorage.getItem("client_id"));
    const storedName = localStorage.getItem("client_name") || "";

    // Say hello to server (it will return name if exists)
    socket.emit("hello", { clientId: storedId, name: storedName });

    // Local cache for filtering
    const ALL = [];

    function reactionsToCounts(reactions){
      const counts = {};
      Object.values(reactions || {}).forEach(e => counts[e] = (counts[e]||0) + 1);
      return counts;
    }
    function countsToString(counts){
      const arr = Object.entries(counts).map(([emo,c]) => `${emo} ${c}`);
      return arr.join(" ");
    }

    function createMsgEl(msg, weatherIcon, weatherLabel){
      const el = document.createElement("div");
      el.className = "msg" + (msg.sender === socket.id ? " me" : "");
      el.dataset.id = msg.id;
      el.dataset.text = (msg.message || "").toLowerCase();
      el.innerHTML = `
        <div class="meta">
          <span class="name">${esc(msg.name)} <span title="${weatherLabel}">${weatherIcon}</span></span>
          <span>‚Ä¢ ${esc(msg.at)}</span>
        </div>
        <div class="text">${esc(msg.message)}</div>
        <div class="actions">
          <span class="reactions">${countsToString(reactionsToCounts(msg.reactions))}</span>
        </div>
        <div class="picker">
          <button>‚ù§Ô∏è</button><button>üëç</button><button>üò°</button><button>üòÇ</button><button title="B·ªè">‚úñÔ∏è</button>
        </div>
      `;

      // reaction picker
      const picker = el.querySelector(".picker");
      picker.addEventListener("click", (e)=>{
        if(e.target.tagName !== "BUTTON") return;
        const emo = e.target.textContent.trim();
        socket.emit("react", { msgId: msg.id, emoji: (emo === "‚úñÔ∏è") ? null : emo });

        // burst animation
        if (emo !== "‚úñÔ∏è") {
          const b = document.createElement("div");
          b.className = "burst";
          b.textContent = emo;
          el.appendChild(b);
          setTimeout(()=> b.remove(), 400);
        }
      });

      return el;
    }

    function appendMsg(msg){
      const wicon = currentWeather.icon || "‚õÖ";
      const wlabel = currentWeather.label || "Nhi·ªÅu m√¢y";
      const el = createMsgEl(msg, wicon, wlabel);
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }

    // Weather from server
    let currentWeather = { icon: "‚õÖ", label: "Nhi·ªÅu m√¢y" };
    socket.on("weather", w => {
      currentWeather = w || currentWeather;
      weatherEl.innerHTML = `<span>${currentWeather.icon}</span><span>${esc(currentWeather.label)}</span>`;
      // update all visible meta icons
      document.querySelectorAll(".meta .name").forEach(n=>{
        n.innerHTML = `${n.textContent.split(' ')[0]} <span title="${currentWeather.label}">${currentWeather.icon}</span>`;
      });
    });

    // Init (history + my name)
    socket.on("init", ({ me, weather, messages })=>{
      if (me?.name) localStorage.setItem("client_name", me.name);
      if (weather) {
        currentWeather = weather;
        weatherEl.innerHTML = `<span>${weather.icon}</span><span>${esc(weather.label)}</span>`;
      }
      (messages || []).forEach(m => { ALL.push(m); appendMsg(m); });
    });

    // System join/leave (optional)
    socket.on("sys", e=>{
      const div = document.createElement("div");
      div.className = "sys";
      if (e.type === "join") div.textContent = `${e.at} ‚Ä¢ ${e.name} ƒë√£ v√†o (${e.online} online)`;
      if (e.type === "leave") div.textContent = `${e.at} ‚Ä¢ ${e.name} ƒë√£ r·ªùi (${e.online} online)`;
      if (e.type === "rename") div.textContent = `${e.at} ‚Ä¢ ${e.name} ƒë√£ ƒë·ªïi t√™n`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    });

    // New chat
    socket.on("chat", msg => { ALL.push(msg); appendMsg(msg); });

    // Update reactions
    socket.on("updateMsg", ({ id, reactions })=>{
      const el = [...document.querySelectorAll(".msg")].find(d => d.dataset.id == id);
      if (el) el.querySelector(".reactions").textContent = countsToString(reactionsToCounts(reactions));
    });

    // Send message
    function send(){
      const t = input.value.trim();
      if(!t) return;
      socket.emit("chat", t);
      input.value = "";
    }
    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", e => { if(e.key === "Enter") send(); });

    // Search
    search.addEventListener("input", e=>{
      const q = e.target.value.toLowerCase();
      document.querySelectorAll(".msg").forEach(m=>{
        m.style.display = (m.dataset.text || "").includes(q) ? "" : "none";
      });
    });
  </script>
</body>
</html>
